@startuml
title Процесс инвентаризации (UC4) - Оффлайн-режим и синхронизация

actor "Оператор" as operator
participant "Мобильное\nприложение" as mobile
participant "Сервис заданий" as tasks
participant "Сервис инвентаризации" as inventory
participant "Сервис уведомлений" as notifications
participant "Технолог" as technologist
database "База остатков" as stock_db
database "База инвентаризации" as inv_db

== Инициация инвентаризации ==

group Автоматически по расписанию
    tasks -> tasks: Проверка расписания\n(настроено технологом)
    tasks -> inventory: Создание задания на инвентаризацию
    inventory -> inv_db: Сохранение задания
    inventory -> tasks: Подтверждение создания
    tasks -> mobile: Push-уведомление оператору\n"Задание на инвентаризацию"
end

opt Выборочная инвентаризация по инициативе оператора
    operator -> mobile: Запрос выборочной инвентаризации\n(выбор зон)
    mobile -> inventory: Создание выборочного задания
    inventory -> inv_db: Сохранение задания
    inventory --> mobile: Подтверждение
end

== Оффлайн-процесс инвентаризации ==

operator -> mobile: Начало инвентаризации
mobile -> inventory: Запрос данных для оффлайн-работы\n(все партии ресторана)
inventory -> stock_db: Получение данных партий
stock_db --> inventory: Данные всех партий
inventory --> mobile: Данные для оффлайн-кэша

group Процесс сканирования (оффлайн)
    loop Для каждой партии в зоне
        operator -> mobile: Сканирование штрих-кода партии
        alt Штрих-код распознан
            mobile -> mobile: Автозаполнение данных партии
        else Штрих-код поврежден
            operator -> mobile: Ручной ввод ID партии
        end
        operator -> mobile: Ввод фактического количества
        mobile -> mobile: Сохранение в локальном кэше\n(штрих-код, количество)
    end
end

operator -> mobile: Завершение инвентаризации

== Синхронизация при появлении сети ==

mobile -> inventory: Отправка оффлайн-данных
inventory -> inv_db: Сохранение результатов инвентаризации

group Обработка конфликтующих изменений
    inventory -> stock_db: Проверка актуальности данных
    stock_db --> inventory: Текущие системные данные
    
    alt Обнаружены конфликтующие изменения
        inventory -> mobile: Уведомление о конфликтах\nс предложением повторить инвентаризацию
        mobile -> operator: Запрос решения по приоритету данных
        operator -> mobile: Выбор приоритета (оффлайн/система)
        mobile -> inventory: Передача решения оператора
    end
end

== Обработка расхождений и утверждение ==

inventory -> inventory: Расчет расхождений\n(факт - система)

loop Для каждой позиции с расхождением
    alt Расхождение ≤ 4000 ед.
        inventory -> stock_db: Автоматическая коррекция остатков
        inventory -> inv_db: Запись в акт под учеткой оператора
        
    else Расхождение > 4000 ед.
        inventory -> notifications: Уведомление о большом расхождении
        notifications -> technologist: SMS + Email\n"Требуется согласование по партии X"
        
        technologist -> inventory: Просмотр расхождения\nв веб-интерфейсе
        
        alt Технолог утверждает коррекцию
            technologist -> inventory: Утверждение коррекции
            inventory -> stock_db: Коррекция остатков
            inventory -> inv_db: Запись в акт под учеткой оператора\nс отметкой об утверждении технологом
            
        else Технолог отклоняет коррекцию
            technologist -> inventory: Отклонение коррекции
            inventory -> inv_db: Запись отклонения в акт
        end
    end
end

== Формирование акта инвентаризации ==

inventory -> inventory: Проверка завершения всех согласований

alt Все расхождения обработаны
    inventory -> inv_db: Формирование финального акта инвентаризации
    inv_db --> inventory: Акт с результатами
    inventory -> mobile: Уведомление о завершении
    mobile -> operator: "Инвентаризация завершена"
end

note right of mobile
    <b>Оффлайн-логика:</b>
    • Кэшируются все партии ресторана
    • Локальное сохранение сканированных данных
    • Автосинхронизация при сети
    • Разрешение конфликтов оператором
end note