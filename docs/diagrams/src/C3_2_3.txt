@startuml
!include <C4/C4_Component>

title Сервис заданий - Компонентная диаграмма (Уровень 3)

Container_Boundary(task_service, "Сервис заданий") {
    Component(task_dispatcher, "Диспетчер заданий", "Spring Bean", "Распределение заданий операторам")
    Component(priority_calculator, "Калькулятор приоритетов", "Spring Bean", "Расчет приоритетов заданий")
    Component(mobile_sync_manager, "Менеджер синхронизации", "Spring Bean", "Синхронизация с мобильным приложением")
    Component(completion_handler, "Обработчик завершения", "Spring Bean", "Подтверждение выполнения заданий")
    
    Component(task_controller, "REST Контроллер", "Spring MVC", "API для управления заданиями")
    Component(task_repository, "Репозиторий заданий", "Spring Data", "Доступ к данным заданий")
    Component(offline_queue, "Очередь оффлайн-работы", "Spring Bean", "Управление оффлайн-операциями")
}

' Внутренние связи
Rel(task_dispatcher, priority_calculator, "Расчет приоритетов", "Метод вызов")
Rel(task_dispatcher, mobile_sync_manager, "Отправка заданий", "Метод вызов")
Rel(mobile_sync_manager, completion_handler, "Подтверждения", "Метод вызов")
Rel(completion_handler, task_repository, "Обновление статусов", "Метод вызов")
Rel(task_controller, task_dispatcher, "API вызовы", "Метод вызов")
Rel(offline_queue, mobile_sync_manager, "Синхронизация", "Метод вызов")

' Внешние зависимости
ContainerDb(tasks_db, "База заданий", "PostgreSQL")
Container_Ext(message_broker, "Брокер сообщений", "Kafka")
Container_Ext(mobile_app, "Мобильное приложение", "REST API")
Container_Ext(stock_service, "Сервис остатков", "REST API")

' Внешние связи
Rel(task_repository, tasks_db, "Чтение/запись", "JDBC")
Rel(message_broker, task_dispatcher, "Получение заданий", "Kafka")
Rel(mobile_sync_manager, mobile_app, "Push уведомления", "REST")
Rel(completion_handler, stock_service, "Подтверждение операций", "REST")
Rel(offline_queue, message_broker, "Синхронизация событий", "Kafka")

Note right of task_dispatcher {
    <b>Логика распределения:</b>
    • Приоритет: утилизация > пополнение
    • Балансировка нагрузки
    • Учет оффлайн-статуса
}
@enduml