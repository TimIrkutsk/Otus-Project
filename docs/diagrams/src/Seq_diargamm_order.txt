@startuml
title Получение прогноза продаж для расчета автозаказа

actor "Сервис заказов" as orders
participant "Сервис интеграции\nс системой продаж" as sales_integration
participant "Система продаж" as sales
participant "Сервис уведомлений" as notifications
participant "Технолог" as technologist
database "База заказов" as orders_db

== Ежедневное получение прогноза по расписанию ==

orders -> orders: Проверка расписания\n(настроено технологом)

alt Время выполнения расписания
    orders -> sales_integration: Запрос прогноза продаж\n(ID ресторана, период=1 день)
    sales_integration -> sales: REST API запрос прогноза\n(ProductID, период)
    
    alt Система продаж доступна
        sales --> sales_integration: Прогноз на завтра\n(ProductID, прогнозируемое количество)
        sales_integration --> orders: Актуальный прогноз
        
    else Система продаж недоступна
        sales_integration --> orders: Ошибка подключения
        orders -> orders_db: Запрос среднего значения заказов\nпо каждому полуфабрикату за 7 дней
        orders_db --> orders: Исторические данные заказов
        orders -> orders: Использование исторических данных\nдля расчета автозаказа
    end
end

== Валидация отклонений прогноза ==

group Проверка аномалий прогноза
    orders -> orders_db: Запрос среднего значения заказов\nза предыдущие 7 дней (для сравнения)
    orders_db --> orders: Средние значения заказов
    
    alt Отклонение > 75% от среднего исторического значения
        orders -> notifications: Уведомление об аномалии прогноза
        notifications -> technologist: Email уведомление\n"Прогноз изменился на X% от среднего"
        
    else Отклонение в пределах нормы
        orders -> orders: Нормальный прогноз - расчет продолжается
    end
end

== Использование прогноза в расчете автозаказа ==

orders -> orders: Расчет автозаказа с использованием:\n- Текущих остатков\n- Прогноза продаж\n- Правил пополнения
orders -> orders_db: Сохранение результатов расчета

note right of orders
    <b>Ключевые параметры:</b>
    • Расписание настраивается технологом
    • Прямой запрос к системе продаж
    • Fallback: среднее заказов за 7 дней
    • Порог аномалии: 75% от исторического среднего
    • Период прогноза: 1 день
end note

== Ручной запрос прогноза (опционально) ==

opt Технолог запрашивает обновление прогноза
    technologist -> orders: Принудительный запрос прогноза
    orders -> sales_integration: Немедленный запрос прогноза
    sales_integration -> sales: REST API запрос
    sales --> sales_integration: Актуальный прогноз
    sales_integration --> orders: Новые данные
    orders --> technologist: Обновленный прогноз
end